"use strict";angular.module("nccor",["angularjs-dropdown-multiselect","ui.slider","trNgGrid"]).filter("nfcurrency",["$filter","$locale",function(e,t){var n=e("currency"),r=t.NUMBER_FORMATS;return function(e,t){var i=n(e,t);return i.replace(new RegExp("\\"+r.DECIMAL_SEP+"\\d{2}"),"")}}]).controller("NccorCtrl",["$scope","$rootScope","$http","$filter",function(e,t,n,r){function s(){if(e.map===undefined){e.map=L.map("map",{minZoom:3,maxZoom:18,scrollWheelZoom:false}).setView([38,-98],4);var t=new L.Google("ROADMAP");e.map.addLayer(t)}e.map.on("moveend",function(){if(e.reset){return 0}e.visibleNids=[];e.processData();var t=[],n=e.map.getBounds();i.eachLayer(function(e){if(n.contains(e.getLatLng())){t.push(e.nid)}});if(e.map.getZoom()>e.map.getMinZoom()){e.zoomedin=true}else{e.zoomedin=false}e.visibleNids=t;e.processData();e.$apply()})}function o(t){var n=t.layer.getAllChildMarkers();var i=t.layer.getBounds().pad(.1);var s=_.reduce(n,function(e,t){return parseInt(e)+parseInt(t.budget)},0);var o=_.map(n,function(e){return e.nid});var u="<h5>"+n.length+" projects</h5>"+"<div>Combined budget amount: <strong>$"+r("number")(s,0)+"</strong></div>";if(e.map.getZoom()==e.map.getMaxZoom()){u+='<div class="scroll-link-container"><a class="scroll-link" onclick="animateScroll(\'#table\');">View details below</a></div>'}else{u+='<div class="scroll-link-container">Click on marker to zoom closer</div>'}return u}function u(){i.clearLayers();var t=L.popup({offset:new L.Point(0,-10)});i.addTo(e.map);i.on("clustermouseover",function(n){t.setLatLng(n.latlng).setContent(o(n));e.map.openPopup(t)}).on("clustermouseout",function(n){if(e.map.getZoom()!=e.map.getMaxZoom()){e.map.closePopup(t)}}).on("clusterblur",function(n){e.map.closePopup(t)}).on("clusterclick",function(n){e.map.closePopup(t);var r=n.layer.getBounds().pad(.1);e.map.fitBounds(r)});var n=e.filteredData;var s=0;for(var u in e.filteredData){if(n[u].latitude!==undefined&&n[u].longitude!==undefined){var a="<h5>"+n[u].title+"</h5>"+"<div>Budget amount: <strong>$"+r("number")(n[u].amount,0)+"</strong></div>";if(e.map.getZoom()==e.map.getMaxZoom()){a+='<div class="scroll-link-container"><a class="scroll-link" onclick="animateScroll(\'#table\');">View details below</a></div>'}else{a+='<div class="scroll-link-container">Click on marker to zoom closer</div>'}var f=L.marker([n[u].latitude,n[u].longitude]).bindPopup(a,{offset:new L.Point(0,-10)}).on("click",function(t){if(e.map.getZoom()!=e.map.getMaxZoom()){e.map.setView(t.latlng,e.map.getMaxZoom(),{reset:false})}}).on("mouseover",function(e){e.target.openPopup()}).on("mouseout",function(t){if(e.map.getZoom()!=e.map.getMaxZoom()){t.target.closePopup()}}).on("blur",function(e){e.target.closePopup()});f.budget=n[u].amount;f.nid=n[u].nid;f.addTo(i)}}}function a(t){e.funders=_.chain(t).uniq(function(e){return e.funder}).filter(function(e){return e.funder!=undefined}).map(function(e){return{id:e.funder,label:e.funder}}).value();e.states=_.chain(t).uniq(function(e){return e.state}).filter(function(e){return e.state!=undefined}).map(function(e){return{id:e.state,label:e.state}}).sortBy(function(e){return e.id}).value();e.years=_.chain(t).uniq(function(e){return e.year}).filter(function(e){return e.year!=undefined}).sortBy(function(e){return e.year}).map(function(e){return{id:e.year,label:e.year}}).value();e.topics=_.chain(t).map(function(e){return e.topics}).flatten().uniq().filter(function(e){return e!=undefined}).map(function(e){return{id:e,label:e}}).value();var n=_.chain(t).uniq(function(e){return e.amount}).filter(function(e){return e.amount!=undefined}).map(function(e){return e.amount}).value();e.amountRange=e.dataAmountRange=f(n)}function f(e){return[parseInt(_.min(e,function(e){return parseInt(e)})),parseInt(_.max(e,function(e){return parseInt(e)}))]}function l(t){for(var n in t){if(typeof t[n].topics==="string"){t[n].topics=t[n].topics.split(",")}if(typeof t[n].investigator==="object"){t[n].investigator=c(t[n].investigator.join(","))}t[n].title=c(t[n].title);t[n].institution=c(t[n].institution)}e.filteredData=e.data=t;_.forEach(e.filteredData,function(e){e.amount=parseInt(e.amount)});a(e.filteredData);e.funder=[];e.state=[];e.year=[];e.topic=[];e.minRange=e.amountRange[0];e.maxRange=e.amountRange[1];s();u()}function c(e){var t=document.createElement("div");t.innerHTML=e;return t.childNodes[0].nodeValue}e.data=[];e.filteredData=[];e.years=[];e.topics=[];e.funders=[];e.states=[];e.visibleNids=[];e.searchString="";e.message="";e.loaded=false;e.reset=false;e.tableFilter="";e.zoomedin=false;TrNgGrid.defaultPagerMinifiedPageCountThreshold=5;e.slider={options:{range:true,slide:function(t,n){e.processData();e.$apply()}}};var i=new L.MarkerClusterGroup({showCoverageOnHover:false,maxClusterRadius:20,singleMarkerMode:true,zoomToBoundsOnClick:false,spiderfyOnMaxZoom:false});e.uncheckAllTopics=function(){e.topic=[];e.processData()};e.uncheckAllYears=function(){e.year=[];e.processData()};e.uncheckAllFunders=function(){e.funder=[];e.processData()};e.uncheckAllStates=function(){e.state=[];e.processData();e.checkZoom()};e.init=function(){e.message="Loading data...";console.log("Requesting remote server...");var t=e.getProjects()};e.resetFilters=function(){e.visibleNids=[];e.reset=true;e.map.setView([38,-98],4,{reset:true});e.reset=false;e.zoomedin=false;e.searchString="";e.getProjects()};e.processSearch=function(t){e.message="Searching...";e.getProjects(t)};e.processData=function(){e.filteredData=_.chain(e.data).filter(function(t){if(e.funder.length===0)return true;var n=_.map(e.funder,function(e){return e.id});return _.intersection(n,Array(t.funder)).length>0}).filter(function(t){if(e.topic.length===0)return true;var n=_.map(e.topic,function(e){return e.id});return _.intersection(n,t.topics).length>0}).filter(function(t){if(e.year.length===0)return true;var n=_.map(e.year,function(e){return e.id});return _.intersection(n,Array(t.year)).length>0}).filter(function(t){if(e.state.length===0)return true;var n=_.map(e.state,function(e){return e.id});return _.intersection(n,Array(t.state)).length>0}).filter(function(t){if(e.amountRange===e.dataAmountRange)return true;return t.amount>=e.amountRange[0]&&t.amount<=e.amountRange[1]}).filter(function(t){if(e.visibleNids.length===0)return true;return _.intersection(e.visibleNids,Array(t.nid)).length>0}).value();u()};e.checkZoom=function(){var t=_.map(e.state,function(e){return e.id});if(_.indexOf(t,"Hawaii")>=0){e.reset=true;e.map.setView([38,-98],3,{reset:true});e.reset=false}else{e.reset=true;e.map.setView([38,-98],4,{reset:true});e.reset=false}};e.changeStates=function(){e.checkZoom();e.processData()};e.filterVisible=function(t){return _.filter(e.filteredData,function(e){if(t.length===0)return false;return _.intersection(t,Array(e.nid)).length>0})};e.getProjects=function(t){if(_.isEmpty(e.cachedData)||t!==undefined){var r="http://map.nccor.org/projects/all?callback=JSON_CALLBACK";if(t!==undefined){r="http://map.nccor.org/projects/search-results/?search_api_views_fulltext="+t+"&callback=JSON_CALLBACK"}var i=n.jsonp(r);i.success(function(n,r,i,s){console.log("Got data from remote server");if(t===undefined){e.cachedData=n}l(n);e.message="";e.loaded=true;$("#map-container").css("visibility","visible");$("#map-container").css("height","auto")});i.error(function(t,n,r,i){console.log("JSONP failed!");e.message="ERROR: Could not get data.";l([])})}else{l(e.cachedData)}}}])