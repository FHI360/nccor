<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="leaflet/leaflet.markercluster/MarkerCluster.css" />
    <link rel="stylesheet" href="leaflet/leaflet.markercluster/MarkerCluster.Default.css" />
    <style type="text/css">
        #map { height: 400px; }
        .cluster: {
            padding: 10px;
            background: red;
        }
    </style>
</head>
</script>
<body data-ng-app="nccor">
    <div data-ng-controller="NccorCtrl" data-ng-init="init()">
        <h3>Showing {{filteredData.length}} records.</h3>
        <select data-ng-change="processData()" data-ng-model="year">
            <option value="">- Show all -</option>
            <option data-ng-repeat="y in years" value="{{y}}">{{y}}</option>
        </select>

        <select data-ng-change="processData()" data-ng-model="agency">
            <option value="">- Show all -</option>
            <option data-ng-repeat="a in agencies" value="{{a}}">{{a}}</option>
        </select>

        <select data-ng-change="processData()" data-ng-model="funder">
            <option value="">- Show all -</option>
            <option data-ng-repeat="f in funders" value="{{f}}">{{f}}</option>
        </select>

        <select data-ng-change="processData()" data-ng-model="state">
            <option value="">- Show all -</option>
            <option data-ng-repeat="s in states" value="{{s}}">{{s}}</option>
        </select>

        <!-- <leaflet center="center" markers="markers" layers="layers" width="640px" height="480px"></leaflet> -->

        <div id="map"></div>

        <ul ng-model="filteredData">
            <li data-ng-repeat="datum in filteredData">{{datum.title}}</li>
        </ul>

    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular.min.js"></script>

<script src="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<script src="leaflet/google/leaflet-google-plugin.js"></script>
<script src="http://leaflet.github.io/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>

<script>
    angular.module('nccor', [])
        .controller('NccorCtrl', ['$scope', '$http', function($scope, $http){
            
            $scope.center = {
                    lat: 24.0391667,
                    lng: 121.525,
                    zoom: 6,
                };

            $scope.map = {};
            $scope.data = {};
            $scope.filteredData = {};
            $scope.year = '';
            $scope.years = [];
            $scope.agency = '';
            $scope.agencies = [];
            $scope.funder = '';
            $scope.funders = [];
            $scope.state = '';
            $scope.states = [];

            var projectsGroup = new L.MarkerClusterGroup({
                showCoverageOnHover: false, 
                maxClusterRadius: 30, 
                singleMarkerMode: true,
                zoomToBoundsOnClick: false
                // iconCreateFunction: function (cluster) {
                //     var markers = cluster.getAllChildMarkers();
                //     var n = 0;
                //     n = markers.length++;
                //     return L.divIcon({ html: '<div class="cluster">' + n + '</div>', className: 'mycluster', iconSize: L.point(40, 40) });
                // },
            });

            $scope.init = function() {
                console.log('Requesting remote server...');

                getAllProjects();
            };

	        $scope.processData = function() {

                $scope.filteredData = _.chain($scope.data)
                    .filter(function(el) { 
                        var funders = [];
                        $scope.funder==''?funders=$scope.funders:funders=Array($scope.funder);
                        return _.intersection(funders, Array(el.funder)).length > 0;
                    })
                    .filter(function(el) {
                        var agencies = [];
                        $scope.agency==''?agencies=$scope.agencies:agencies=Array($scope.agency);
                        return _.intersection(agencies, Array(el.agency)).length > 0;
                    })
                    .filter(function(el) {
                        var  years= [];
                        $scope.year==''?years=$scope.years:years=Array($scope.year);
                        return _.intersection(years, Array(el.year)).length > 0;
		    })
                    .filter(function(el) {
                        var  states= [];
                        $scope.state==''?states=$scope.states:states=Array($scope.state);
                        return _.intersection(states, Array(el.state)).length > 0;
		    })
                    .value();
                placeMarkers();
                console.log($scope.filteredData);
            };

            function getAllProjects() {
                var responsePromise = $http.jsonp("http://map.nccor.org/projects/all?callback=JSON_CALLBACK");

                responsePromise.success(function(data, status, headers, config) {
                    console.log( "Got data from remote server" );
                    initData(data);
                    //console.table(data);
                });
                responsePromise.error(function(data, status, headers, config) {
                    console.log("JSONP failed!"); 
                    return [];
                });
            }

            function initData(data) {
                $scope.filteredData = $scope.data = data;
                renderFilters($scope.filteredData);
                initMap();
                placeMarkers();
            }

            function renderFilters(data) {
                $scope.funders = _.chain(data).uniq(function(obj) {return obj.funder}).map(function(el) { return el.funder }).sortBy(function(el) { return el; }).value();
                $scope.years = _.chain(data).uniq(function(obj) {return obj.year}).map(function(el) { return el.year }).sortBy(function(el) { return el; }).value();
                $scope.agencies= _.chain(data).uniq(function(obj) {return obj.agency}).map(function(el) { return el.agency }).sortBy(function(el) { return el; }).value();
                $scope.states= _.chain(data).uniq(function(obj) {return obj.state}).map(function(el) { return el.state }).filter(function(el) {return el!=undefined}).sortBy(function(el) { return el; }).value();
            }

            function initMap() {
                $scope.map = L.map('map').setView([39.186, -96.583], 4);
                var googleLayer = new L.Google('ROADMAP');
                $scope.map.addLayer(googleLayer);
            }

            function placeMarkers() {
                projectsGroup.clearLayers();
                var popup = L.popup();
                projectsGroup.addTo($scope.map);
                projectsGroup.on('clusterclick', function (a) {
                    children = a.layer.getAllChildMarkers();
                    console.log(a);
                    popup.setLatLng(a.latlng)
                        .setContent('<p>Hello world!<br />This is a nice popup.</p>');
                    $scope.map.openPopup(popup);
                })
                .on('clusterblur', function(a) {
                    console.log(a);
                    $scope.map.closePopup(popup);
                });

                var projects = $scope.filteredData;
                for (var key in $scope.filteredData) {
                    if((projects[key].latitude != undefined) && (projects[key].longitude != undefined))
                        var marker = L.marker([projects[key].latitude, projects[key].longitude]).bindPopup(projects[key].title).on('click', function(evt) {evt.target.openPopup(); }).on('blur', function(evt) {evt.target.closePopup(); });
                        marker.budget = projects[key].amount;
                        marker.addTo(projectsGroup);
                }
            }

        }]);
</script>
</html>